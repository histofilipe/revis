<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Visualizador QR + Curadoria (CSV)</title>
  <style>
    :root { --gap: 10px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .grid { display: grid; gap: var(--gap); grid-template-columns: 1fr; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; }
    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    button, select, input[type="file"] { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; background: #fff; }
    button { cursor: pointer; }
    button.primary { background: #111; color: #fff; border-color: #111; }
    button.danger { background: #b00020; color: #fff; border-color: #b00020; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .status { padding: 10px 12px; border-radius: 10px; background: #f6f6f6; border: 1px solid #e6e6e6; }
    .ok { border-color: #b7e3b7; background: #f1fff1; }
    .warn { border-color: #ffd6a6; background: #fff8ef; }
    .err { border-color: #ffb3b3; background: #fff2f2; }
    #reader { width: 100%; max-width: 520px; min-height: 240px; border-radius: 12px; overflow: hidden; border: 1px dashed #bbb; display: flex; align-items: center; justify-content: center; }
    #reader > div { width: 100%; }
    textarea { width: 100%; min-height: 110px; border-radius: 12px; border: 1px solid #ddd; padding: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .small { font-size: 12px; color: #666; line-height: 1.35; }
    @media (min-width: 900px) {
      .grid { grid-template-columns: 1fr 1fr; }
    }
  </style>

  <!-- Carrega html5-qrcode com fallback de CDN -->
  <script>
    (function loadHtml5Qr(){
      const s = document.createElement("script");
      s.src = "https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js";
      s.onload = () => console.log("html5-qrcode OK (unpkg)");
      s.onerror = () => {
        console.warn("Falhou unpkg, tentando jsdelivr...");
        const s2 = document.createElement("script");
        s2.src = "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js";
        s2.onload = () => console.log("html5-qrcode OK (jsdelivr)");
        s2.onerror = () => console.error("Falhou carregar html5-qrcode em ambos CDNs");
        document.head.appendChild(s2);
      };
      document.head.appendChild(s);
    })();
  </script>
</head>

<body>
  <h1>Visualizador de QRCode + Curadoria (Upload CSV)</h1>

  <div class="grid">
    <div class="card">
      <div class="row">
        <input id="csvFile" type="file" accept=".csv,text/csv" />
        <button id="btnLoadCsv" class="primary">Carregar CSV</button>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <label for="selNp"><b>NP</b></label>
        <select id="selNp" style="min-width:260px" disabled>
          <option value="">— Carregue um CSV —</option>
        </select>

        <button id="btnCopy" disabled>Copiar NP</button>
      </div>

      <div style="height:10px"></div>

      <div class="status" id="statusBox">
        <b>Status:</b> <span id="statusText">Aguardando CSV…</span>
        <div class="small" id="statusHint"></div>
      </div>

      <div style="height:10px"></div>

      <div class="small">
        <b>Dica:</b> Se o “teste da câmera” funcionar mas o leitor não abrir, normalmente é bloqueio do CDN da biblioteca (html5-qrcode).
        Esse arquivo já tenta <i>unpkg</i> e depois <i>jsdelivr</i>.
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnTestCam">Testar câmera (nativo)</button>
        <button id="btnStart" class="primary">Iniciar leitor QR</button>
        <button id="btnStop" class="danger" disabled>Parar leitor</button>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <label for="selCam"><b>Câmera</b></label>
        <select id="selCam" style="min-width:260px" disabled>
          <option value="">— Detectando câmeras… —</option>
        </select>
      </div>

      <div style="height:10px"></div>

      <div id="reader">
        <div class="small" style="padding:10px; text-align:center;">
          Área do leitor QR. Clique em “Iniciar leitor QR”.
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="small"><b>Último QR lido</b></div>
      <textarea id="lastQr" readonly placeholder="—"></textarea>
    </div>
  </div>

  <script>
    // =========================
    // Helpers de UI
    // =========================
    const el = (id) => document.getElementById(id);

    function setStatus(kind, text, hint="") {
      const box = el("statusBox");
      box.classList.remove("ok","warn","err");
      if (kind) box.classList.add(kind);
      el("statusText").textContent = text;
      el("statusHint").textContent = hint;
    }

    function normalizeHeader(h) {
      return String(h || "")
        .trim()
        .replace(/\uFEFF/g, "") // BOM
        .toLowerCase();
    }

    // CSV bem simples (funciona com ; ou , e aspas)
    function parseCsv(text) {
      // Detecta delimitador pelo header
      const firstLine = text.split(/\r?\n/).find(l => l.trim().length > 0) || "";
      const delimiter = (firstLine.split(";").length > firstLine.split(",").length) ? ";" : ",";
      const rows = [];
      let cur = "";
      let inQuotes = false;
      let row = [];

      for (let i=0; i<text.length; i++) {
        const ch = text[i];
        const next = text[i+1];

        if (ch === '"' ) {
          if (inQuotes && next === '"') { cur += '"'; i++; }
          else inQuotes = !inQuotes;
          continue;
        }

        if (!inQuotes && ch === delimiter) {
          row.push(cur);
          cur = "";
          continue;
        }

        if (!inQuotes && (ch === "\n" || ch === "\r")) {
          if (ch === "\r" && next === "\n") i++;
          row.push(cur);
          const isEmpty = row.every(v => String(v).trim() === "");
          if (!isEmpty) rows.push(row);
          row = [];
          cur = "";
          continue;
        }

        cur += ch;
      }

      // Última linha
      if (cur.length || row.length) {
        row.push(cur);
        const isEmpty = row.every(v => String(v).trim() === "");
        if (!isEmpty) rows.push(row);
      }

      if (rows.length === 0) return { header: [], data: [] };

      const header = rows[0].map(h => String(h ?? "").trim());
      const data = rows.slice(1).map(r => {
        const obj = {};
        for (let c=0; c<header.length; c++) obj[header[c]] = r[c] ?? "";
        return obj;
      });

      return { header, data, delimiter };
    }

    // =========================
    // Estado
    // =========================
    let csvData = [];
    let npKey = null; // nome da coluna NP/np
    let html5QrCode = null;
    let scanning = false;

    // =========================
    // CSV: carregar e popular dropdown
    // =========================
    async function loadCsvFromFile(file) {
      const text = await file.text();
      const parsed = parseCsv(text);

      if (!parsed.header.length) {
        setStatus("err", "CSV vazio ou inválido.", "Verifique se o arquivo tem cabeçalho e linhas.");
        return;
      }

      // Detecta a coluna NP (aceita NP, np, Np...)
      const headerNorm = parsed.header.map(normalizeHeader);
      const idxNp = headerNorm.findIndex(h => h === "np");
      if (idxNp < 0) {
        setStatus("err", "Não encontrei a coluna NP no CSV.", "O cabeçalho precisa ter uma coluna chamada 'NP' (qualquer capitalização).");
        return;
      }

      npKey = parsed.header[idxNp];
      csvData = parsed.data;

      // Lista de NPs únicos
      const set = new Set();
      for (const row of csvData) {
        const v = String(row[npKey] ?? "").trim();
        if (v) set.add(v);
      }
      const nps = Array.from(set).sort((a,b)=>a.localeCompare(b, "pt-BR"));

      const sel = el("selNp");
      sel.innerHTML = "";
      if (nps.length === 0) {
        sel.appendChild(new Option("— Sem NPs —", ""));
        sel.disabled = true;
        el("btnCopy").disabled = true;
        setStatus("warn", "CSV carregado, mas não encontrei valores em NP.", "Confira se a coluna NP tem valores preenchidos.");
        return;
      }

      sel.appendChild(new Option("— Selecione —", ""));
      for (const v of nps) sel.appendChild(new Option(v, v));

      sel.disabled = false;
      el("btnCopy").disabled = false;
      setStatus("ok", `CSV carregado. NPs encontrados: ${nps.length}`, `Coluna detectada: "${npKey}" • Delimitador: ${parsed.delimiter}`);
    }

    // =========================
    // Câmera: teste nativo (getUserMedia)
    // =========================
    async function testCameraNative() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        stream.getTracks().forEach(t => t.stop());
        setStatus("ok", "Teste nativo OK: permissão de câmera concedida.", "Agora tente ‘Iniciar leitor QR’.");
      } catch (e) {
        console.error(e);
        setStatus("err", "Falha no teste nativo de câmera.", String(e?.message || e));
      }
    }

    // =========================
    // html5-qrcode: lista câmeras e inicia
    // =========================
    async function refreshCameraList() {
      const selCam = el("selCam");

      if (typeof Html5Qrcode === "undefined") {
        selCam.innerHTML = `<option value="">— Biblioteca do leitor não carregou —</option>`;
        selCam.disabled = true;
        return;
      }

      try {
        const cams = await Html5Qrcode.getCameras();
        selCam.innerHTML = "";
        if (!cams || cams.length === 0) {
          selCam.appendChild(new Option("— Nenhuma câmera encontrada —", ""));
          selCam.disabled = true;
          return;
        }

        // Prioriza traseira por heurística (móvel)
        const prefer = cams.find(c => /back|traseira|rear|environment/i.test(c.label || ""));
        const firstId = (prefer || cams[0]).id;

        for (const c of cams) {
          selCam.appendChild(new Option(c.label || `Camera ${c.id}`, c.id));
        }

        selCam.value = firstId;
        selCam.disabled = false;
      } catch (e) {
        console.error(e);
        selCam.innerHTML = `<option value="">— Erro ao listar câmeras —</option>`;
        selCam.disabled = true;
      }
    }

    async function startScanner() {
      // Checagem: biblioteca carregou?
      if (typeof Html5Qrcode === "undefined") {
        setStatus("err", "A biblioteca do leitor (html5-qrcode) não carregou.", "Provável bloqueio de CDN/rede. Veja o Console (F12).");
        return;
      }

      if (scanning) return;

      // Lista câmeras (se ainda não)
      await refreshCameraList();
      const camId = el("selCam").value;

      if (!camId) {
        setStatus("err", "Sem câmera selecionada.", "Permita a câmera e recarregue a página.");
        return;
      }

      try {
        html5QrCode = new Html5Qrcode("reader");
      } catch (e) {
        console.error(e);
        html5QrCode = null;
        setStatus("err", "Erro ao criar o leitor de QR.", "Veja o Console (F12) para detalhes.");
        return;
      }

      const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        experimentalFeatures: { useBarCodeDetectorIfSupported: true }
      };

      setStatus("warn", "Iniciando leitor…", "Se não abrir, cheque permissões e Console (F12).");

      try {
        scanning = true;
        el("btnStart").disabled = true;
        el("btnStop").disabled = false;

        await html5QrCode.start(
          { deviceId: { exact: camId } },
          config,
          (decodedText) => {
            el("lastQr").value = decodedText;
            setStatus("ok", "QR lido com sucesso!", decodedText.slice(0, 120));
            // Se quiser parar ao ler 1 vez, descomente:
            // stopScanner();
          },
          (errorMessage) => {
            // Erros de frame são normais; não precisa “spammar” status.
            // console.debug(errorMessage);
          }
        );

        setStatus("ok", "Leitor ativo.", "Aponte para o QRCode.");
      } catch (e) {
        console.error(e);
        setStatus("err", "Falha ao iniciar o leitor.", String(e?.message || e));
        scanning = false;
        el("btnStart").disabled = false;
        el("btnStop").disabled = true;
        try { await html5QrCode?.stop(); } catch {}
        html5QrCode = null;
      }
    }

    async function stopScanner() {
      if (!html5QrCode || !scanning) return;
      try {
        await html5QrCode.stop();
        await html5QrCode.clear();
      } catch (e) {
        console.warn(e);
      }
      html5QrCode = null;
      scanning = false;
      el("btnStart").disabled = false;
      el("btnStop").disabled = true;
      setStatus("warn", "Leitor parado.", "Você pode iniciar novamente quando quiser.");
    }

    // =========================
    // Copiar NP
    // =========================
    async function copySelectedNp() {
      const v = el("selNp").value;
      if (!v) return;
      try {
        await navigator.clipboard.writeText(v);
        setStatus("ok", "NP copiada!", v);
      } catch (e) {
        // fallback
        try {
          const ta = document.createElement("textarea");
          ta.value = v;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          setStatus("ok", "NP copiada!", v);
        } catch (err) {
          setStatus("err", "Não consegui copiar para a área de transferência.", String(err?.message || err));
        }
      }
    }

    // =========================
    // Eventos
    // =========================
    el("btnLoadCsv").addEventListener("click", async () => {
      const file = el("csvFile").files?.[0];
      if (!file) {
        setStatus("warn", "Selecione um arquivo CSV primeiro.", "");
        return;
      }
      await loadCsvFromFile(file);
    });

    el("btnTestCam").addEventListener("click", testCameraNative);
    el("btnStart").addEventListener("click", startScanner);
    el("btnStop").addEventListener("click", stopScanner);
    el("btnCopy").addEventListener("click", copySelectedNp);

    // Quando troca câmera, reinicia se estiver ativo
    el("selCam").addEventListener("change", async () => {
      if (scanning) {
        await stopScanner();
        await startScanner();
      }
    });

    // Bootstrap: checa APIs e tenta listar câmeras quando lib carregar
    (function init() {
      if (!navigator.mediaDevices?.getUserMedia) {
        setStatus("err", "Seu navegador não suporta câmera (getUserMedia).", "Use Chrome/Edge/Safari atualizado.");
        return;
      }

      setStatus("warn", "Pronto. Carregue um CSV e/ou inicie o leitor.", "");

      // espera a lib carregar (até ~5s)
      let tries = 0;
      const t = setInterval(async () => {
        tries++;
        if (typeof Html5Qrcode !== "undefined") {
          clearInterval(t);
          await refreshCameraList();
          return;
        }
        if (tries >= 50) { // 50 * 100ms = 5s
          clearInterval(t);
          setStatus("warn", "A biblioteca do leitor ainda não carregou.", "Se o teste nativo funcionar e o leitor não, é bloqueio de CDN/rede.");
        }
      }, 100);
    })();
  </script>
</body>
</html>
